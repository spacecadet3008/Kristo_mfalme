{% extends 'base.html' %}
{% load static %}

{% block internal_style %}
<style>
    .member-search-results {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%;
        display: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 4px;
        margin-top: 2px;
    }
    .member-option {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    .member-option:hover {
        background-color: #f5f5f5;
    }
    .member-option:last-child {
        border-bottom: none;
    }
    .member-option strong {
        color: #2e59d9;
    }
    .form-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    .readonly-field {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }
    .search-loading {
        padding: 10px;
        text-align: center;
        color: #666;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-main-wrapper">
    <div class="dashboard-wrapper">
        <div class="container-fluid dashboard-content">
            <!-- Page Header -->
            <div class="row">
                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                    <div class="page-header">
                        <h2 class="pageheader-title">
                            <i class="fas fa-money-bill-wave mr-2"></i>
                            {% if title %}{{ title }}{% else %}{% if form.instance.pk %}Edit{% else %}Add New{% endif %} Tithe Payment{% endif %}
                        </h2>
                        <div class="page-breadcrumb">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{% url 'home' %}" class="breadcrumb-link">Home</a></li>
                                    <li class="breadcrumb-item"><a href="{% url 'tithepayment:tithepayment_list' %}" class="breadcrumb-link">Tithe Payments</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">
                                        {% if form.instance.pk %}Edit{% else %}Add{% endif %} Payment
                                    </li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
            <div class="row">
                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="row">
                <!-- Form -->
                <div class="col-xl-8 col-lg-8 col-md-12 col-sm-12 col-12">
                    <div class="card">
                        <div class="card-body">
                            <form method="post" id="tithePaymentForm">
                                {% csrf_token %}
                                
                                {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Member Search and Selection -->
                                <div class="form-group">
                                    <label for="member_search">Select Member *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="member_search" 
                                               placeholder="Type member name to search..." autocomplete="off"
                                               value="{% if form.instance.name %}{{ form.instance.name.name }}{% endif %}">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button" id="clear_search" title="Clear Search">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="member-search-results" id="member_search_results"></div>
                                    <small class="form-text text-muted">Type at least 2 characters to search members</small>
                                    
                                    <!-- Hidden field for selected member -->
                                    <input type="hidden" id="selected_member_id" name="name" 
                                           value="{% if form.instance.name %}{{ form.instance.name.id }}{% endif %}">
                                    
                                    <!-- Display selected member info -->
                                    <div id="selected_member_display" 
                                         class="mt-2 p-2 border rounded bg-light" 
                                         style="{% if not form.instance.name %}display: none;{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong id="selected_member_name">
                                                    {% if form.instance.name %}{{ form.instance.name.name }}{% endif %}
                                                </strong>
                                                <br>
                                                <small class="text-muted" id="selected_member_telephone">
                                                    {% if form.instance.name %}{{ form.instance.name.telephone|default:"No telephone" }}{% endif %}
                                                </small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="remove_member" title="Remove Member">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Display form errors for name field -->
                                    {% if form.name.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.name.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Telephone (Read-only) -->
                                <div class="form-group">
                                    <label>Telephone</label>
                                    <input type="text" class="form-control readonly-field" 
                                           id="telephone_display" readonly
                                           value="{% if form.instance.name %}{{ form.instance.name.telephone|default:'' }}{% endif %}">
                                    <input type="hidden" id="id_contact_number" name="contact_number"
                                           value="{% if form.instance.name %}{{ form.instance.name.telephone|default:'' }}{% endif %}">
                                    
                                    {% if form.contact_number.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.contact_number.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Amount -->
                                <div class="form-group">
                                    <label for="{{ form.amount.id_for_label }}">Amount *</label>
                                    {{ form.amount }}
                                    {% if form.amount.errors %}
                                    <div class="text-danger">
                                        {% for error in form.amount.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Payment Method -->
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}">Payment Method *</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <div class="text-danger">
                                        {% for error in form.status.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Date -->
                                <div class="form-group">
                                    <label for="{{ form.date.id_for_label }}">Payment Date</label>
                                    {{ form.date }}
                                    {% if form.date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.date.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Form Actions -->
                                <div class="form-group text-right">
                                    <a href="{% url 'tithepayment:tithepayment_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> 
                                        {% if form.instance.pk %}Update{% else %}Create{% endif %} Payment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="col-xl-4 col-lg-4 col-md-12 col-sm-12 col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="fas fa-info-circle mr-2"></i>Quick Help</h5>
                        </div>
                        <div class="card-body">
                            <h6>Adding Tithe Payments:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success mr-2"></i>Search for member by name</li>
                                <li><i class="fas fa-check text-success mr-2"></i>Telephone auto-fills</li>
                                <li><i class="fas fa-check text-success mr-2"></i>Select payment method</li>
                                <li><i class="fas fa-check text-success mr-2"></i>Enter payment amount</li>
                            </ul>
                            <div class="alert alert-warning mt-3">
                                <strong>Note:</strong> Telephone is automatically retrieved from member record.
                            </div>
                        </div>
                    </div>

                    <!-- Recent Payments -->
                    {% if form.instance.pk %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title"><i class="fas fa-history mr-2"></i>Payment History</h5>
                        </div>
                        <div class="card-body">
                            <p>This payment was created on <strong>{{ form.instance.date|date:"M d, Y" }}</strong></p>
                            <a href="{% url 'tithepayment:tithepayment_detail' form.instance.pk %}" class="btn btn-info btn-sm">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    let memberSearchTimeout;
    const memberSearchInput = $('#member_search');
    const memberSearchResults = $('#member_search_results');
    const selectedMemberId = $('#selected_member_id');
    const telephoneDisplay = $('#telephone_display');
    const contactNumberInput = $('#id_contact_number');
    const selectedMemberDisplay = $('#selected_member_display');
    const selectedMemberName = $('#selected_member_name');
    const selectedMemberTelephone = $('#selected_member_telephone');

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Member search functionality
    memberSearchInput.on('input', function() {
        clearTimeout(memberSearchTimeout);
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            memberSearchResults.hide().empty();
            return;
        }

        memberSearchTimeout = setTimeout(function() {
            // Show loading indicator
            memberSearchResults.html('<div class="search-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Searching members...</div>').show();
            
            console.log('Sending search request for:', query);
            
            $.ajax({
                url: '{% url "tithepayment:search_members" %}',
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: {
                    'search': query
                },
                success: function(data, status, xhr) {
                    console.log('Search successful! Status:', status);
                    console.log('Response data:', data);
                    console.log('Response headers:', xhr.getAllResponseHeaders());
                    
                    memberSearchResults.empty();
                    
                    if (data.error) {
                        memberSearchResults.html('<div class="member-option text-danger">Server Error: ' + data.error + '</div>').show();
                        return;
                    }
                    
                    if (data.members && data.members.length > 0) {
                        console.log('Found', data.members.length, 'members');
                        data.members.forEach(function(member, index) {
                            console.log('Member', index, ':', member);
                            const option = $('<div class="member-option"></div>');
                            const memberName = member.name || '';
                            const telephone = member.telephone || 'No telephone';
                            
                            // Create highlighted name
                            const displayName = highlightMatch(memberName, query);
                            
                            option.html(`
                                <div class="font-weight-bold">${displayName}</div>
                                <small class="text-muted">${telephone}</small>
                            `);
                            
                            option.data({
                                'member-id': member.id,
                                'name': memberName,
                                'telephone': telephone
                            });
                            
                            option.click(function() {
                                selectMember(
                                    $(this).data('member-id'),
                                    $(this).data('name'),
                                    $(this).data('telephone')
                                );
                            });
                            
                            memberSearchResults.append(option);
                        });
                        memberSearchResults.show();
                    } else {
                        console.log('No members found in response');
                        memberSearchResults.html('<div class="member-option text-muted">No members found for "' + query + '"</div>').show();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error Details:');
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('XHR Status:', xhr.status);
                    console.error('XHR Status Text:', xhr.statusText);
                    console.error('Response Text:', xhr.responseText);
                    
                    let errorMsg = 'Error connecting to server';
                    if (xhr.status === 404) {
                        errorMsg = 'Search endpoint not found (404). Check URL.';
                    } else if (xhr.status === 403) {
                        errorMsg = 'Access forbidden. Please login again.';
                    } else if (xhr.status === 500) {
                        errorMsg = 'Server error. Check Django console.';
                    } else if (xhr.status === 0) {
                        errorMsg = 'Network error. Check if server is running.';
                    }
                    
                    memberSearchResults.html('<div class="member-option text-danger">' + errorMsg + ' (Status: ' + xhr.status + ')</div>').show();
                },
                complete: function() {
                    console.log('AJAX request completed');
                }
            });
        }, 500);
    });

    // Helper function to highlight matches
    function highlightMatch(text, query) {
        if (!query || !text) return text;
        
        try {
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        } catch (e) {
            return text;
        }
    }

    // Select member function
    function selectMember(memberId, name, telephone) {
        console.log('Selecting member:', {memberId, name, telephone});
        
        // Set the hidden input value
        selectedMemberId.val(memberId);
        
        // Update telephone display (read-only)
        telephoneDisplay.val(telephone);
        contactNumberInput.val(telephone);
        
        // Update selected member display
        selectedMemberName.text(name);
        selectedMemberTelephone.text(telephone || 'No telephone');
        selectedMemberDisplay.show();
        
        // Clear search input and results
        memberSearchInput.val('');
        memberSearchResults.hide().empty();
        
        // Focus on amount field
        $('#id_amount').focus();
    }

    // Clear search button
    $('#clear_search').click(function() {
        memberSearchInput.val('');
        memberSearchResults.hide().empty();
        memberSearchInput.focus();
    });

    // Remove selected member
    $('#remove_member').click(function() {
        selectedMemberId.val('');
        telephoneDisplay.val('');
        contactNumberInput.val('');
        selectedMemberDisplay.hide();
        memberSearchInput.focus();
    });

    // Hide search results when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#member_search, #member_search_results').length) {
            memberSearchResults.hide();
        }
    });

    // Test the URL
    console.log('=== DEBUG INFO ===');
    console.log('Search URL:', '{% url "tithepayment:search_members" %}');
    console.log('Full URL:', window.location.origin + '{% url "tithepayment:search_members" %}');
    console.log('CSRF Token exists:', csrftoken ? 'Yes' : 'No');
    console.log('Member search input exists:', memberSearchInput.length > 0);
    console.log('=== END DEBUG ===');

    // Form validation
    $('#tithePaymentForm').on('submit', function(e) {
        const memberId = selectedMemberId.val();
        const amount = $('#id_amount').val();
        
        if (!memberId) {
            e.preventDefault();
            alert('❌ Please select a member from the search results.');
            memberSearchInput.focus();
            return false;
        }
        
        if (!amount || parseFloat(amount) <= 0) {
            e.preventDefault();
            alert('❌ Please enter a valid amount greater than 0.');
            $('#id_amount').focus();
            return false;
        }
        
        return true;
    });
});
</script>
{% endblock %}