{% extends 'base.html' %}
{% load static %}

{% block internal_style %}
<style>
    /* Ministry Form Styles */
    .ministry-form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-lg);
    }
    
    .form-header {
        margin-bottom: var(--space-xl);
        text-align: center;
    }
    
    .form-header h1 {
        color: var(--primary);
        margin-bottom: var(--space-sm);
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
    }
    
    .form-header p {
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }
    
    .form-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--divider);
        margin-bottom: var(--space-xl);
    }
    
    .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-sm);
        border-bottom: 2px solid var(--primary-light);
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-title i {
        color: var(--primary);
        font-size: 1.2rem;
    }
    
    /* Feast Information */
    .feast-section {
        background: rgba(251, 188, 4, 0.05);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        border: 1px solid rgba(251, 188, 4, 0.2);
        margin-bottom: var(--space-xl);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
    }
    
    .form-group {
        margin-bottom: var(--space-lg);
    }
    
    .form-label {
        display: block;
        margin-bottom: var(--space-sm);
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.9rem;
    }
    
    .form-label.required::after {
        content: " *";
        color: var(--danger);
    }
    
    .form-control {
        width: 100%;
        padding: 12px var(--space-md);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        transition: all var(--transition-fast);
        background: var(--surface);
        color: var(--text-primary);
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
    }
    
    .form-select {
        width: 100%;
        padding: 12px var(--space-md);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        font-family: "Poppins", sans-serif;
        background: var(--surface);
        color: var(--text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235f6368' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--space-md) center;
        background-size: 16px;
        padding-right: calc(var(--space-md) * 2 + 16px);
    }
    
    /* Leaders Table Styles */
    .leaders-table-container {
        overflow-x: auto;
        margin-bottom: var(--space-lg);
    }
    
    .leaders-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .leaders-table th {
        background: var(--background);
        padding: var(--space-md);
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--divider);
        white-space: nowrap;
    }
    
    .leaders-table td {
        padding: var(--space-md);
        border-bottom: 1px solid var(--divider);
        color: var(--text-primary);
    }
    
    .leaders-table tbody tr:hover {
        background: var(--background);
    }
    
    .leaders-table input,
    .leaders-table select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        font-family: "Poppins", sans-serif;
        transition: all var(--transition-fast);
    }
    
    .leaders-table input:focus,
    .leaders-table select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: var(--space-sm);
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid var(--divider);
        background: var(--surface);
        color: var(--text-primary);
        font-size: 1rem;
    }
    
    .btn-icon:hover {
        background: var(--background);
        transform: translateY(-2px);
    }
    
    .btn-icon.add {
        color: var(--success);
        border-color: var(--success);
    }
    
    .btn-icon.remove {
        color: var(--danger);
        border-color: var(--danger);
    }
    
    .btn-icon.add:hover {
        background: rgba(52, 168, 83, 0.1);
    }
    
    .btn-icon.remove:hover {
        background: rgba(234, 67, 53, 0.1);
    }
    
    .empty-row {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        padding: var(--space-xl) !important;
        background: var(--background);
    }
    
    .error-message {
        display: block;
        margin-top: 6px;
        font-size: 0.8rem;
        color: var(--danger);
        font-weight: 500;
    }
    
    .error-field {
        border-color: var(--danger) !important;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-md);
        margin-top: var(--space-xl);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--divider);
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: none;
        font-family: "Poppins", sans-serif;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        text-decoration: none;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        border: 1px solid var(--primary);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
        background: var(--background);
        color: var(--text-primary);
        border: 1px solid var(--divider);
    }
    
    .btn-secondary:hover {
        background: var(--divider);
        transform: translateY(-2px);
    }
    
    .info-box {
        background: rgba(66, 133, 244, 0.1);
        border-left: 4px solid var(--info);
        padding: var(--space-md);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-lg);
    }
    
    .info-box p {
        margin: 0;
        color: var(--text-primary);
        font-size: 0.9rem;
        display: flex;
        align-items: flex-start;
        gap: var(--space-sm);
    }
    
    .info-box p i {
        margin-top: 2px;
    }
    
    .stats-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--background);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        border: 1px solid var(--divider);
    }
    
    .stat-item {
        text-align: center;
        flex: 1;
    }
    
    .stat-value {
        display: block;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 4px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
        .ministry-form-container {
            padding: var(--space-md);
        }
        
        .form-card {
            padding: var(--space-lg);
        }
        
        .form-row {
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
        
        .leaders-table {
            font-size: 0.8rem;
            min-width: 800px; /* Make table scrollable on mobile */
        }
        
        .leaders-table th,
        .leaders-table td {
            padding: var(--space-sm);
        }
        
        .stats-box {
            flex-direction: column;
            gap: var(--space-md);
        }
    }
    
    @media (max-width: 480px) {
        .form-header h1 {
            font-size: 1.5rem;
        }
        
        .form-card {
            padding: var(--space-md);
        }
        
        .section-title {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ministry-form-container">
    <div class="form-header">
        <h1><i class="fas fa-users-cog"></i> Add Ministry Leaders</h1>
        <p>Add leaders with their community, position, and contact information. Each position must be unique within a community.</p>
    </div>
    
    <!-- Display Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
                <div class="alert-icon">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle"></i>
                    {% else %}
                        <i class="fas fa-exclamation-circle"></i>
                    {% endif %}
                </div>
                <div class="alert-content">
                    <p>{{ message }}</p>
                </div>
                <button class="alert-close" onclick="this.parentElement.style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="form-card">
        <form method="POST" action="{% url 'create_ministry' %}" id="ministryForm">
            {% csrf_token %}
            
            <!-- Feast Information (Optional) -->
            <div class="feast-section">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Feast Information (Optional)</span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="name" class="form-label">Ministry Name</label>
                        <input type="text" 
                               name="ministry_name" 
                               id="name" 
                               class="form-control" 
                               placeholder="Enter Ministry name"
                               maxlength="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="feast_date" class="form-label">Feast Date</label>
                        <input type="date" 
                               name="feast_date" 
                               id="feast_date" 
                               class="form-control">
                    </div>
                </div>
            </div>
            
            <!-- Leaders Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-user-tie"></i>
                    <span>Ministry Leaders</span>
                </div>
                
                <div class="info-box">
                    <p><i class="fas fa-info-circle"></i> Each leader will be individually linked to their community. Position (Chair Person, Secretary, etc.) must be unique per community.</p>
                </div>
                
                <div class="stats-box">
                    <div class="stat-item">
                        <span class="stat-value" id="leaderCount">0</span>
                        <span class="stat-label">Leaders</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="communityCount">0</span>
                        <span class="stat-label">Communities</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="positionCount">0</span>
                        <span class="stat-label">Positions</span>
                    </div>
                </div>
                
                <div class="leaders-table-container">
                    <table class="leaders-table" id="leadersTable">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Leader Name *</th>
                                <th style="width: 25%;">Community *</th>
                                <th style="width: 20%;">Position/Rank *</th>
                                <th style="width: 20%;">Phone Number</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadersTableBody">
                            <!-- Rows will be added dynamically -->
                            <tr id="emptyRow" class="empty-row">
                                <td colspan="5">Click "Add Leader" to add your first leader</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center">
                    <button type="button" class="btn btn-primary" onclick="addLeaderRow()">
                        <i class="fas fa-plus"></i> Add Leader
                    </button>
                </div>
            </div>
            
            <!-- Hidden fields for form submission -->
            <input type="hidden" name="leaders_name[]" id="leadersNameHidden" value="">
            <input type="hidden" name="leaders_community[]" id="leadersCommunityHidden" value="">
            <input type="hidden" name="leaders_position[]" id="leadersPositionHidden" value="">
            <input type="hidden" name="leaders_phone[]" id="leadersPhoneHidden" value="">
            
            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% url 'list_ministries' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save All Leaders
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    let leaderRowCount = 0;
    let leaderRows = [];
    
    // Position choices from Django model
    const positionChoices = [
        ['', 'Select Position'],
        ['CHAIR PERSON', 'Chair Person'],
        ['VICE CHAIR', 'Vice Chair'],
        ['SECRETARY', 'Secretary'],
        ['VICE SECRETARY', 'Vice Secretary'],
        ['ACCOUNTANT', 'Accountant'],
        ['COORDINATOR', 'Coordinator']
    ];

    document.addEventListener('DOMContentLoaded', function() {
        // Add first row automatically
        addLeaderRow();
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('feast_date').min = today;
    });

    function addLeaderRow() {
        const tableBody = document.getElementById('leadersTableBody');
        const emptyRow = document.getElementById('emptyRow');
        
        // Remove empty row message if it exists
        if (emptyRow) {
            emptyRow.remove();
        }
        
        leaderRowCount++;
        const rowId = `leaderRow_${leaderRowCount}`;
        
        // Create position options HTML
        let positionOptionsHtml = '';
        positionChoices.forEach(([value, label]) => {
            positionOptionsHtml += `<option value="${value}">${label}</option>`;
        });
        
        // Create community options HTML
        let communityOptionsHtml = '<option value="">Select Community</option>';
        {% for community in communities %}
            communityOptionsHtml += `<option value="{{ community.id }}">{{ community.name }}</option>`;
        {% endfor %}
        
        const rowHtml = `
            <tr id="${rowId}">
                <td>
                    <input type="text" 
                           name="leader_name_${leaderRowCount}" 
                           class="form-control leader-name" 
                           placeholder="Enter leader's name"
                           maxlength="250"
                           required
                           oninput="updateStats()">
                </td>
                <td>
                    <select name="leader_community_${leaderRowCount}" 
                            class="form-select leader-community"
                            required
                            onchange="updateStats()">
                        ${communityOptionsHtml}
                    </select>
                </td>
                <td>
                    <select name="leader_position_${leaderRowCount}" 
                            class="form-select leader-position"
                            required
                            onchange="updateStats()">
                        ${positionOptionsHtml}
                    </select>
                </td>
                <td>
                    <input type="tel" 
                           name="leader_phone_${leaderRowCount}" 
                           class="form-control leader-phone" 
                           placeholder="Phone number"
                           oninput="formatPhone(this); updateStats()">
                </td>
                <td>
                    <div class="action-buttons">
                        <button type="button" class="btn-icon remove" onclick="removeLeaderRow('${rowId}')" title="Remove Leader">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        
        tableBody.insertAdjacentHTML('beforeend', rowHtml);
        leaderRows.push(rowId);
        updateHiddenFields();
        updateStats();
    }

    function removeLeaderRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
            leaderRows = leaderRows.filter(id => id !== rowId);
        }
        
        // Check if table is empty
        const tableBody = document.getElementById('leadersTableBody');
        if (tableBody.children.length === 0) {
            tableBody.innerHTML = `
                <tr id="emptyRow" class="empty-row">
                    <td colspan="5">Click "Add Leader" to add your first leader</td>
                </tr>
            `;
        }
        
        updateHiddenFields();
        updateStats();
    }

    function updateHiddenFields() {
        const names = [];
        const communities = [];
        const positions = [];
        const phones = [];
        
        leaderRows.forEach(rowId => {
            const row = document.getElementById(rowId);
            if (row) {
                const nameInput = row.querySelector('.leader-name');
                const communitySelect = row.querySelector('.leader-community');
                const positionSelect = row.querySelector('.leader-position');
                const phoneInput = row.querySelector('.leader-phone');
                
                if (nameInput && communitySelect && positionSelect) {
                    names.push(nameInput.value.trim());
                    communities.push(communitySelect.value);
                    positions.push(positionSelect.value);
                    phones.push(phoneInput ? phoneInput.value.trim() : '');
                }
            }
        });
        
        // Update hidden fields
        document.getElementById('leadersNameHidden').value = names.join(',,');
        document.getElementById('leadersCommunityHidden').value = communities.join(',,');
        document.getElementById('leadersPositionHidden').value = positions.join(',,');
        document.getElementById('leadersPhoneHidden').value = phones.join(',,');
    }

    function formatPhone(input) {
        // Remove all non-digit characters
        let value = input.value.replace(/\D/g, '');
        
        // Format as (123) 456-7890 if length is appropriate
        if (value.length > 3 && value.length <= 6) {
            value = value.replace(/(\d{3})(\d+)/, '($1) $2');
        } else if (value.length > 6) {
            value = value.replace(/(\d{3})(\d{3})(\d+)/, '($1) $2-$3');
        }
        
        input.value = value;
        updateHiddenFields();
    }

    function updateStats() {
        const leaderCount = leaderRows.length;
        const communities = new Set();
        const positions = new Set();
        
        leaderRows.forEach(rowId => {
            const row = document.getElementById(rowId);
            if (row) {
                const communitySelect = row.querySelector('.leader-community');
                const positionSelect = row.querySelector('.leader-position');
                
                if (communitySelect && communitySelect.value) {
                    communities.add(communitySelect.value);
                }
                if (positionSelect && positionSelect.value) {
                    positions.add(positionSelect.value);
                }
            }
        });
        
        document.getElementById('leaderCount').textContent = leaderCount;
        document.getElementById('communityCount').textContent = communities.size;
        document.getElementById('positionCount').textContent = positions.size;
        
        updateHiddenFields();
    }

    // Form validation
    document.getElementById('ministryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        const errorMessages = [];
        const positionCommunityMap = {}; // Track position+community combinations
        
        // Check for at least one leader
        if (leaderRows.length === 0) {
            isValid = false;
            errorMessages.push('Please add at least one leader');
        }
        
        // Validate each leader row
        leaderRows.forEach(rowId => {
            const row = document.getElementById(rowId);
            if (row) {
                const nameInput = row.querySelector('.leader-name');
                const communitySelect = row.querySelector('.leader-community');
                const positionSelect = row.querySelector('.leader-position');
                
                // Check required fields
                if (!nameInput.value.trim()) {
                    isValid = false;
                    nameInput.classList.add('error-field');
                    errorMessages.push(`Row ${rowId}: Leader name is required`);
                } else {
                    nameInput.classList.remove('error-field');
                }
                
                if (!communitySelect.value) {
                    isValid = false;
                    communitySelect.classList.add('error-field');
                    errorMessages.push(`Row ${rowId}: Please select a community`);
                } else {
                    communitySelect.classList.remove('error-field');
                }
                
                if (!positionSelect.value) {
                    isValid = false;
                    positionSelect.classList.add('error-field');
                    errorMessages.push(`Row ${rowId}: Please select a position`);
                } else {
                    positionSelect.classList.remove('error-field');
                }
                
                // Check for duplicate position within same community
                if (communitySelect.value && positionSelect.value) {
                    const key = `${communitySelect.value}_${positionSelect.value}`;
                    if (positionCommunityMap[key]) {
                        isValid = false;
                        positionSelect.classList.add('error-field');
                        const communityName = communitySelect.options[communitySelect.selectedIndex].text;
                        const positionName = positionSelect.options[positionSelect.selectedIndex].text;
                        errorMessages.push(`${positionName} position already assigned in ${communityName}`);
                    } else {
                        positionCommunityMap[key] = true;
                    }
                }
            }
        });
        
        if (isValid) {
            this.submit();
        } else {
            // Show error messages
            alert('Please fix the following errors:\n\n' + errorMessages.join('\n'));
            
            // Scroll to first error
            const firstError = document.querySelector('.error-field');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
    
    // Auto-hide alerts after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.style.display = 'none', 300);
        });
    }, 5000);
</script>
{% endblock %}