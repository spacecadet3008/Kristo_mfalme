{% extends 'base.html' %}
{% load static %}

{% block title %}Create Notification{% endblock %}

{% block internal_style %}
<style>
    /* Create Notification Specific Styles */
    .create-notification-container {
        padding: var(--space-xl);
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: var(--space-xl);
        padding-bottom: var(--space-lg);
        border-bottom: 1px solid var(--divider);
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--space-xs);
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 1rem;
        margin: 0;
    }

    .notification-form-wrapper {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-xl);
    }

    @media (max-width: 992px) {
        .notification-form-wrapper {
            grid-template-columns: 1fr;
        }
    }

    .main-form-section {
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--space-xl);
    }

    .sidebar-section {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
    }

    .form-section {
        margin-bottom: var(--space-xl);
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 2px solid var(--divider);
    }

    .section-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .section-header i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-lg);
    }

    .form-group {
        margin-bottom: var(--space-lg);
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        display: block;
        margin-bottom: var(--space-sm);
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--danger);
    }

    .form-control {
        width: 100%;
        padding: var(--space-md) var(--space-lg);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        background: var(--surface);
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: 'Poppins', sans-serif;
        transition: all var(--transition-fast);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .form-control.error {
        border-color: var(--danger);
        background: rgba(234, 67, 53, 0.05);
    }

    textarea.form-control {
        min-height: 150px;
        resize: vertical;
        line-height: 1.5;
    }

    .form-select {
        width: 100%;
        padding: var(--space-md) var(--space-lg);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        background: var(--surface);
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: 'Poppins', sans-serif;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235f6368' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--space-lg) center;
        background-size: 16px;
        padding-right: calc(var(--space-lg) * 2 + 16px);
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .radio-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .radio-item {
        position: relative;
    }

    .radio-item input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .radio-item label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-xs);
        padding: var(--space-md) var(--space-sm);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        background: var(--background);
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-secondary);
        text-align: center;
        transition: all var(--transition-fast);
    }

    .radio-item label:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .radio-item input[type="radio"]:checked + label {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        font-weight: 500;
    }

    .priority-label {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    .priority-label i {
        font-size: 0.8rem;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm);
        border-radius: var(--radius-md);
        transition: background var(--transition-fast);
    }

    .checkbox-item:hover {
        background: var(--background);
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
    }

    .checkbox-item label {
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--text-secondary);
        flex: 1;
    }

    .form-help {
        font-size: 0.85rem;
        color: var(--text-disabled);
        margin-top: var(--space-xs);
        font-style: italic;
    }

    .character-counter {
        font-size: 0.8rem;
        color: var(--text-disabled);
        text-align: right;
        margin-top: var(--space-xs);
    }

    .character-counter.warning {
        color: var(--warning);
    }

    .character-counter.danger {
        color: var(--danger);
    }

    .error-message {
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: var(--space-xs);
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    /* Sidebar Cards */
    .sidebar-card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        padding: var(--space-lg);
    }

    .sidebar-card h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-md);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .sidebar-card h3 i {
        color: var(--primary);
    }

    /* Recipient Selection */
    .recipient-selection {
        position: relative;
    }

    .recipient-search {
        position: relative;
        margin-bottom: var(--space-md);
    }

    .recipient-search input {
        width: 100%;
        padding: var(--space-md) var(--space-lg) var(--space-md) 40px;
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
    }

    .recipient-search i {
        position: absolute;
        left: var(--space-md);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-disabled);
    }

    .recipient-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        background: var(--background);
    }

    .recipient-item {
        padding: var(--space-md);
        border-bottom: 1px solid var(--divider);
        cursor: pointer;
        transition: background var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .recipient-item:last-child {
        border-bottom: none;
    }

    .recipient-item:hover {
        background: rgba(26, 115, 232, 0.05);
    }

    .recipient-item.selected {
        background: rgba(26, 115, 232, 0.1);
        border-left: 3px solid var(--primary);
    }

    .recipient-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .recipient-info {
        flex: 1;
    }

    .recipient-name {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .recipient-email {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Preview Card */
    .preview-card {
        position: sticky;
        top: var(--space-lg);
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
    }

    .preview-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-sm);
        word-break: break-word;
    }

    .preview-message {
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: var(--space-lg);
        font-size: 0.95rem;
        word-break: break-word;
    }

    .preview-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        padding-top: var(--space-md);
        border-top: 1px solid var(--divider);
        font-size: 0.85rem;
        color: var(--text-disabled);
    }

    .preview-meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-md);
        padding-top: var(--space-xl);
        margin-top: var(--space-xl);
        border-top: 1px solid var(--divider);
    }

    .btn {
        padding: var(--space-md) var(--space-xl);
        border-radius: var(--radius-md);
        border: none;
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
        text-decoration: none;
        font-family: 'Poppins', sans-serif;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-primary:disabled {
        background: var(--text-disabled);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-secondary {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--divider);
    }

    .btn-secondary:hover {
        background: var(--background);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .btn-outline-danger {
        background: transparent;
        color: var(--danger);
        border: 1px solid var(--danger);
    }

    .btn-outline-danger:hover {
        background: var(--danger);
        color: white;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid var(--divider);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .create-notification-container {
            padding: var(--space-md);
        }

        .main-form-section {
            padding: var(--space-lg);
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }

        .radio-group {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .create-notification-container {
            padding: var(--space-sm);
        }

        .page-header h1 {
            font-size: 1.5rem;
        }

        .main-form-section {
            padding: var(--space-md);
        }

        .btn {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.9rem;
        }
    }

    /* Icon Selection */
    .icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .icon-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-sm);
        border: 1px solid var(--divider);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        background: var(--background);
    }

    .icon-item:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    .icon-item.selected {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .icon-item i {
        font-size: 1.2rem;
        margin-bottom: var(--space-xs);
    }

    .icon-item span {
        font-size: 0.7rem;
        text-align: center;
    }

    /* Custom scrollbar for recipient list */
    .recipient-list::-webkit-scrollbar {
        width: 6px;
    }

    .recipient-list::-webkit-scrollbar-track {
        background: var(--background);
        border-radius: var(--radius-full);
    }

    .recipient-list::-webkit-scrollbar-thumb {
        background: var(--divider);
        border-radius: var(--radius-full);
    }

    .recipient-list::-webkit-scrollbar-thumb:hover {
        background: var(--text-disabled);
    }

    /* Error styling */
    .has-error .form-control {
        border-color: var(--danger);
    }

    .has-error .form-label {
        color: var(--danger);
    }

    /* Success styling */
    .has-success .form-control {
        border-color: var(--success);
    }
</style>
{% endblock %}

{% block content %}
<div class="create-notification-container">
    <div class="page-header">
        <h1>Create New Notification</h1>
        <p>Send personalized notifications to church members</p>
    </div>

    {% if form.errors %}
    <div class="error-card" style="background: rgba(234, 67, 53, 0.1); border: 1px solid var(--danger); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg);">
        <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
            <h4 style="margin: 0; color: var(--danger);">Please fix the errors below:</h4>
        </div>
        <ul style="margin: 0; padding-left: var(--space-lg); color: var(--danger); font-size: 0.9rem;">
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="notification-form-wrapper">
        <!-- Main Form Section -->
        <div class="main-form-section">
            <form method="post" id="notificationForm" class="notification-form">
                {% csrf_token %}
                
                <!-- Basic Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-info-circle"></i>
                        <h2>Basic Information</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group {% if form.title.errors %}has-error{% endif %}">
                            <label for="{{ form.title.id_for_label }}" class="form-label required">
                                {{ form.title.label }}
                            </label>
                            {{ form.title }}
                            <div class="character-counter">
                                <span id="title-count">0</span>/255 characters
                            </div>
                            {% if form.title.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.title.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group {% if form.notification_type.errors %}has-error{% endif %}">
                            <label for="{{ form.notification_type.id_for_label }}" class="form-label required">
                                Notification Type
                            </label>
                            {{ form.notification_type }}
                            {% if form.notification_type.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.notification_type.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group full-width {% if form.message.errors %}has-error{% endif %}">
                        <label for="{{ form.message.id_for_label }}" class="form-label required">
                            {{ form.message.label }}
                        </label>
                        {{ form.message }}
                        <div class="character-counter">
                            <span id="message-count">0</span> characters
                        </div>
                        <div class="form-help">
                            You can use HTML formatting for better presentation
                        </div>
                        {% if form.message.errors %}
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ form.message.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Priority & Settings Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-cog"></i>
                        <h2>Settings & Priority</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group {% if form.priority.errors %}has-error{% endif %}">
                            <label class="form-label required">Priority Level</label>
                            <div class="radio-group">
                                {% for value, label in form.fields.priority.choices %}
                                <div class="radio-item">
                                    <input type="radio" 
                                           id="priority-{{ value }}" 
                                           name="priority" 
                                           value="{{ value }}"
                                           {% if form.priority.value == value or not form.priority.value and value == 'medium' %}checked{% endif %}>
                                    <label for="priority-{{ value }}" class="priority-label">
                                        {% if value == 'urgent' %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% elif value == 'high' %}
                                            <i class="fas fa-exclamation-circle"></i>
                                        {% elif value == 'medium' %}
                                            <i class="fas fa-info-circle"></i>
                                        {% else %}
                                            <i class="fas fa-check-circle"></i>
                                        {% endif %}
                                        {{ label }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% if form.priority.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.priority.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group {% if form.icon.errors %}has-error{% endif %}">
                            <label for="{{ form.icon.id_for_label }}" class="form-label">
                                Icon
                            </label>
                            {{ form.icon }}
                            <div class="form-help">
                                Font Awesome icon class (e.g., fas fa-bell, fas fa-calendar)
                            </div>
                            {% if form.icon.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.icon.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Scheduling Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-calendar-alt"></i>
                        <h2>Scheduling</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group {% if form.scheduled_for.errors %}has-error{% endif %}">
                            <label for="{{ form.scheduled_for.id_for_label }}" class="form-label">
                                Schedule Send
                            </label>
                            {{ form.scheduled_for }}
                            <div class="form-help">
                                Leave empty to send immediately
                            </div>
                            {% if form.scheduled_for.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.scheduled_for.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group {% if form.expires_at.errors %}has-error{% endif %}">
                            <label for="{{ form.expires_at.id_for_label }}" class="form-label">
                                Expiry Date
                            </label>
                            {{ form.expires_at }}
                            <div class="form-help">
                                When should this notification expire?
                            </div>
                            {% if form.expires_at.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.expires_at.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Action & Related Content Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-link"></i>
                        <h2>Action & Related Content</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group {% if form.action_url.errors %}has-error{% endif %}">
                            <label for="{{ form.action_url.id_for_label }}" class="form-label">
                                Action URL
                            </label>
                            {{ form.action_url }}
                            <div class="form-help">
                                URL to redirect when notification is clicked
                            </div>
                            {% if form.action_url.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.action_url.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group {% if form.content_type.errors %}has-error{% endif %}">
                            <label for="{{ form.content_type.id_for_label }}" class="form-label">
                                Related Content Type
                            </label>
                            {{ form.content_type }}
                            <div class="form-help">
                                Type of related content (optional)
                            </div>
                            {% if form.content_type.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.content_type.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group {% if form.object_id.errors %}has-error{% endif %}">
                            <label for="{{ form.object_id.id_for_label }}" class="form-label">
                                Related Object ID
                            </label>
                            {{ form.object_id }}
                            <div class="form-help">
                                ID of related object (optional)
                            </div>
                            {% if form.object_id.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ form.object_id.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="draftBtn">
                        <i class="fas fa-save"></i>
                        Save as Draft
                    </button>
                    <button type="reset" class="btn btn-outline-danger">
                        <i class="fas fa-redo"></i>
                        Reset Form
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Notification
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar Section -->
        <div class="sidebar-section">
            <!-- Recipient Selection Card -->
            <div class="sidebar-card">
                <h3><i class="fas fa-users"></i> Recipient</h3>
                <div class="recipient-selection">
                    <div class="form-group {% if form.recipient.errors %}has-error{% endif %}">
                        <label class="form-label required">Select Recipient</label>
                        <div class="recipient-search">
                            <i class="fas fa-search"></i>
                            <input type="text" 
                                   id="recipient-search" 
                                   placeholder="Search members..." 
                                   onkeyup="filterRecipients()">
                        </div>
                        <div class="recipient-list" id="recipient-list">
                            {% for user in users %}
                            <div class="recipient-item" 
                                 data-user-id="{{ user.id }}"
                                 onclick="selectRecipient(this)"
                                 {% if form.recipient.value == user.id|stringformat:"s" %}data-selected="true"{% endif %}>
                                <div class="recipient-avatar">
                                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                                </div>
                                <div class="recipient-info">
                                    <div class="recipient-name">
                                        {{ user.get_full_name|default:user.username }}
                                    </div>
                                    <div class="recipient-email">
                                        {{ user.email }}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <p>No users available</p>
                            </div>
                            {% endfor %}
                        </div>
                        {{ form.recipient }}
                        {% if form.recipient.errors %}
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ form.recipient.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Preview Card -->
            <div class="sidebar-card preview-card">
                <div class="preview-header">
                    <h3><i class="fas fa-eye"></i> Preview</h3>
                    <div class="form-help">
                        Updates as you type
                    </div>
                </div>
                
                <div id="preview-content">
                    <div class="preview-title" id="preview-title">
                        {{ form.title.value|default:"Notification Title" }}
                    </div>
                    <div class="preview-message" id="preview-message">
                        {{ form.message.value|default:"Your notification message will appear here..." }}
                    </div>
                    <div class="preview-meta">
                        <div class="preview-meta-item">
                            <i class="fas fa-bell"></i>
                            <span id="preview-type">
                                {% if form.notification_type.value %}
                                    {{ form.notification_type.field.choices_dict|get_item:form.notification_type.value }}
                                {% else %}
                                    Announcement
                                {% endif %}
                            </span>
                        </div>
                        <div class="preview-meta-item">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="preview-priority">
                                {% if form.priority.value %}
                                    {{ form.priority.value|title }} Priority
                                {% else %}
                                    Medium Priority
                                {% endif %}
                            </span>
                        </div>
                        <div class="preview-meta-item">
                            <i class="fas fa-user"></i>
                            <span id="preview-recipient">
                                {% if form.recipient.value %}
                                    {% for user in users %}
                                        {% if user.id == form.recipient.value %}
                                            {{ user.get_full_name|default:user.username }}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    No recipient selected
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Tips Card -->
            <div class="sidebar-card">
                <h3><i class="fas fa-lightbulb"></i> Quick Tips</h3>
                <ul style="margin: 0; padding-left: var(--space-md); color: var(--text-secondary); font-size: 0.9rem;">
                    <li>Keep titles clear and concise</li>
                    <li>Use appropriate priority levels</li>
                    <li>Schedule for optimal timing</li>
                    <li>Add action URLs for follow-up</li>
                    <li>Set expiry dates for time-sensitive notifications</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block internal_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize hidden recipient field
    const recipientField = document.getElementById('{{ form.recipient.id_for_label }}');
    recipientField.style.display = 'none';
    
    // Auto-select recipient if value exists
    if (recipientField.value) {
        const recipientItem = document.querySelector(`.recipient-item[data-user-id="${recipientField.value}"]`);
        if (recipientItem) {
            recipientItem.classList.add('selected');
            updatePreview();
        }
    }
    
    // Character counters
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const messageInput = document.getElementById('{{ form.message.id_for_label }}');
    const titleCount = document.getElementById('title-count');
    const messageCount = document.getElementById('message-count');

    function updateCounter(input, counter, max = null) {
        const length = input.value.length;
        counter.textContent = length;
        
        if (max) {
            counter.textContent = `${length}/${max}`;
            if (length > max * 0.9) {
                counter.classList.add('danger');
            } else if (length > max * 0.75) {
                counter.classList.add('warning');
            } else {
                counter.classList.remove('warning', 'danger');
            }
        }
    }

    if (titleInput) {
        titleInput.addEventListener('input', () => updateCounter(titleInput, titleCount, 255));
        updateCounter(titleInput, titleCount, 255);
    }

    if (messageInput) {
        messageInput.addEventListener('input', () => updateCounter(messageInput, messageCount));
        updateCounter(messageInput, messageCount);
    }

    // Preview updates
    const previewTitle = document.getElementById('preview-title');
    const previewMessage = document.getElementById('preview-message');
    const previewType = document.getElementById('preview-type');
    const previewPriority = document.getElementById('preview-priority');
    const previewRecipient = document.getElementById('preview-recipient');

    function updatePreview() {
        if (titleInput && previewTitle) {
            previewTitle.textContent = titleInput.value || 'Notification Title';
        }
        
        if (messageInput && previewMessage) {
            previewMessage.textContent = messageInput.value || 'Your notification message will appear here...';
        }
        
        const typeSelect = document.getElementById('{{ form.notification_type.id_for_label }}');
        if (typeSelect && previewType) {
            if (typeSelect.value) {
                previewType.textContent = typeSelect.options[typeSelect.selectedIndex].text;
            } else {
                previewType.textContent = 'Announcement';
            }
        }
        
        const priorityRadio = document.querySelector('input[name="priority"]:checked');
        if (priorityRadio && previewPriority) {
            previewPriority.textContent = `${priorityRadio.value.charAt(0).toUpperCase() + priorityRadio.value.slice(1)} Priority`;
        }
        
        if (recipientField && previewRecipient) {
            if (recipientField.value) {
                const selectedItem = document.querySelector(`.recipient-item[data-user-id="${recipientField.value}"]`);
                if (selectedItem) {
                    const name = selectedItem.querySelector('.recipient-name').textContent;
                    previewRecipient.textContent = name;
                }
            } else {
                previewRecipient.textContent = 'No recipient selected';
            }
        }
    }

    // Update preview on input
    if (titleInput) titleInput.addEventListener('input', updatePreview);
    if (messageInput) messageInput.addEventListener('input', updatePreview);
    
    const typeSelect = document.getElementById('{{ form.notification_type.id_for_label }}');
    if (typeSelect) typeSelect.addEventListener('change', updatePreview);
    
    document.querySelectorAll('input[name="priority"]').forEach(radio => {
        radio.addEventListener('change', updatePreview);
    });

    // Initialize preview
    updatePreview();

    // Recipient selection
    window.selectRecipient = function(element) {
        const recipientItems = document.querySelectorAll('.recipient-item');
        recipientItems.forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        
        const userId = element.getAttribute('data-user-id');
        recipientField.value = userId;
        
        updatePreview();
    };

    window.filterRecipients = function() {
        const searchTerm = document.getElementById('recipient-search').value.toLowerCase();
        const recipientItems = document.querySelectorAll('.recipient-item');
        
        recipientItems.forEach(item => {
            const name = item.querySelector('.recipient-name').textContent.toLowerCase();
            const email = item.querySelector('.recipient-email').textContent.toLowerCase();
            
            if (name.includes(searchTerm) || email.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    };

    // Form submission
    const form = document.getElementById('notificationForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitBtn = document.getElementById('submitBtn');
    const draftBtn = document.getElementById('draftBtn');

    if (form) {
        form.addEventListener('submit', function(e) {
            // No need to prevent default, let form submit normally
            // Show loading
            if (loadingOverlay) loadingOverlay.classList.add('show');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            }
            
            // Form will submit normally now
        });
    }

    if (draftBtn) {
        draftBtn.addEventListener('click', function() {
            // Create a draft version
            const draftData = new FormData(form);
            draftData.append('save_as_draft', 'true');
            draftData.append('status', 'pending');
            
            // Validate at least title and message
            if (!titleInput.value.trim() || !messageInput.value.trim()) {
                alert('Please enter at least a title and message to save as draft');
                return;
            }
            
            if (loadingOverlay) loadingOverlay.classList.add('show');
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            fetch(form.action, {
                method: 'POST',
                body: draftData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.json();
                }
            })
            .then(data => {
                if (data && data.success) {
                    alert('Draft saved successfully!');
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                } else if (data && data.error) {
                    alert('Error saving draft: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error saving draft');
            })
            .finally(() => {
                if (loadingOverlay) loadingOverlay.classList.remove('show');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save"></i> Save as Draft';
            });
        });
    }

    // Form reset
    if (form) {
        form.addEventListener('reset', function() {
            // Clear recipient selection
            document.querySelectorAll('.recipient-item').forEach(item => {
                item.classList.remove('selected');
            });
            if (recipientField) recipientField.value = '';
            
            // Reset preview
            updatePreview();
            
            // Clear error states
            document.querySelectorAll('.has-error').forEach(el => {
                el.classList.remove('has-error');
            });
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to save draft
        if (e.ctrlKey && e.key === 's' && draftBtn) {
            e.preventDefault();
            draftBtn.click();
        }
        
        // Ctrl+Enter to submit
        if (e.ctrlKey && e.key === 'Enter' && submitBtn) {
            e.preventDefault();
            submitBtn.click();
        }
    });

    // Initialize datetime-local inputs with proper format
    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Set min datetime for scheduled_for to now
    const scheduledInput = document.getElementById('{{ form.scheduled_for.id_for_label }}');
    if (scheduledInput) {
        const now = new Date();
        scheduledInput.min = formatDateTimeLocal(now);
        
        // Set default to 5 minutes from now if empty
        if (!scheduledInput.value) {
            const defaultTime = new Date(now.getTime() + 5 * 60000);
            scheduledInput.value = formatDateTimeLocal(defaultTime);
        }
    }

    // Set min datetime for expires_at to scheduled_for or now
    const expiresInput = document.getElementById('{{ form.expires_at.id_for_label }}');
    if (expiresInput) {
        const scheduledValue = scheduledInput ? scheduledInput.value : null;
        if (scheduledValue) {
            expiresInput.min = scheduledValue;
        } else {
            expiresInput.min = formatDateTimeLocal(new Date());
        }
        
        // Set default to 24 hours from scheduled time or now
        if (!expiresInput.value) {
            const baseTime = scheduledValue ? new Date(scheduledValue) : new Date();
            const defaultExpiry = new Date(baseTime.getTime() + 24 * 60 * 60000);
            expiresInput.value = formatDateTimeLocal(defaultExpiry);
        }
    }

    // Update expires_at min when scheduled_for changes
    if (scheduledInput && expiresInput) {
        scheduledInput.addEventListener('change', function() {
            if (this.value) {
                expiresInput.min = this.value;
            } else {
                expiresInput.min = formatDateTimeLocal(new Date());
            }
        });
    }

    // Icon suggestions
    const iconSuggestions = {
        'announcement': 'fas fa-bullhorn',
        'event': 'fas fa-calendar-alt',
        'prayer_request': 'fas fa-pray',
        'donation': 'fas fa-hand-holding-usd',
        'attendance': 'fas fa-user-check',
        'birthday': 'fas fa-birthday-cake',
        'anniversary': 'fas fa-heart',
        'volunteer': 'fas fa-hands-helping',
        'meeting': 'fas fa-users',
        'broadcast': 'fas fa-broadcast-tower',
        'reminder': 'fas fa-clock',
        'alert': 'fas fa-exclamation-triangle'
    };

    if (typeSelect) {
        const iconInput = document.getElementById('{{ form.icon.id_for_label }}');
        if (iconInput) {
            typeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                if (selectedType && iconSuggestions[selectedType] && !iconInput.value) {
                    iconInput.value = iconSuggestions[selectedType];
                }
            });
        }
    }
});
</script>
{% endblock %}