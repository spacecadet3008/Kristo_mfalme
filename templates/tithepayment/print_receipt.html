{% extends 'base.html' %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="container-fluid dashboard-content">
        <div class="col-xl-6 col-lg-8 col-md-10 col-sm-12 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Print Tithe Receipt</h5>
                    <div class="float-right">
                        <span class="badge {% if receipt.is_printed %}badge-success{% else %}badge-warning{% endif %}">
                            {% if receipt.is_printed %}Printed{% else %}Not Printed{% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Receipt Preview -->
                    <div id="receipt-preview" class="border p-4 bg-light" style="font-family: 'Courier New', monospace;">
                        <div class="text-center mb-3">
                            <h4 class="mb-1" style="font-weight: bold;">{{ receipt.church_name }}</h4>
                            <p class="mb-1 small">{{ receipt.church_address }}</p>
                            <p class="mb-1 small">Tel: {{ receipt.church_phone }}</p>
                        </div>
                        
                        <hr style="border-top: 2px dashed #000; margin: 10px 0;">
                        
                        <div class="text-center mb-3">
                            <h5 style="font-weight: bold;">TITHE RECEIPT</h5>
                        </div>
                        
                        <table style="width: 100%; font-size: 14px;">
                            <tr>
                                <td style="width: 40%;"><strong>Receipt No:</strong></td>
                                <td>{{ receipt.receipt_number }}</td>
                            </tr>
                            <tr>
                                <td><strong>Date:</strong></td>
                                <td>{{ payment.date|date:"Y-m-d" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Time:</strong></td>
                                <td>{{ payment.date|date:"H:i" }}</td>
                            </tr>
                        </table>
                        
                        <hr style="border-top: 1px dashed #000; margin: 10px 0;">
                        
                        <table style="width: 100%; font-size: 14px;">
                            <tr>
                                <td style="width: 40%;"><strong>Member Name:</strong></td>
                                <td>{{ payment.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Phone:</strong></td>
                                <td>{{ payment.contact_number }}</td>
                            </tr>
                            <tr>
                                <td><strong>Payment Method:</strong></td>
                                <td>{{ payment.get_status_display }}</td>
                            </tr>
                        </table>
                        
                        <hr style="border-top: 1px dashed #000; margin: 10px 0;">
                        
                        <div style="text-align: center; margin: 15px 0;">
                            <h4 style="font-weight: bold; margin: 0;">TZS {{ payment.amount|floatformat:2 }}</h4>
                            <small>Amount Paid</small>
                        </div>
                        
                        <hr style="border-top: 1px dashed #000; margin: 10px 0;">
                        
                        <div style="font-size: 12px; text-align: center; margin-top: 20px;">
                            <p style="margin: 5px 0;">Generated on: {{ receipt.generated_at|date:"Y-m-d H:i" }}</p>
                            {% if receipt.is_printed %}
                            <p style="margin: 5px 0;">Printed on: {{ receipt.printed_at|date:"Y-m-d H:i" }}</p>
                            {% endif %}
                            <p style="margin: 10px 0; font-weight: bold;">Thank you for your tithe!</p>
                        </div>
                    </div>
                    
                    <!-- Print Controls -->
                    <div class="mt-4 text-center">
                        <button id="print-receipt" class="btn btn-success mr-2">
                            <i class="fa fa-print"></i> Print Receipt
                        </button>
                        <a href="{% url 'receipt_list' %}" class="btn btn-primary">
                            <i class="fa fa-list"></i> All Receipts
                        </a>
                        {% if not receipt.is_printed %}
                        <a href="{% url 'generate_receipt' payment.id %}" class="btn btn-warning">
                            <i class="fa fa-redo"></i> Regenerate
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('print-receipt').addEventListener('click', function() {
    const button = this;
    const originalText = button.innerHTML;
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Printing...';
    
    fetch("{% url 'print_receipt' receipt.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Receipt printed successfully!');
            // Reload page to update status
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('Printing failed: ' + data.message);
        }
    })
    .catch(error => {
        alert('Printing error: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
});
</script>
{% endblock %}